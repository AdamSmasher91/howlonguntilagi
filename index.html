<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>How Long Until AGI?</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            background: #ffffff;
            color: #333;
            line-height: 1.6;
        }

        .main-wrapper {
            display: flex;
            min-height: 100vh;
        }

        .ad-space {
            width: 200px;
            background: #f8f9fa;
            padding: 20px;
            border: 1px solid #e9ecef;
            display: none;
        }

        @media (min-width: 1400px) {
            .ad-space {
                display: block;
            }
        }

        .ad-placeholder {
            background: #e9ecef;
            height: 600px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 14px;
            text-align: center;
        }

        .container {
            flex: 1;
            max-width: 1000px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        header {
            text-align: center;
            margin-bottom: 50px;
            padding-bottom: 30px;
            border-bottom: 2px solid #f0f0f0;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .subtitle {
            font-size: 1.1rem;
            color: #7f8c8d;
            margin-bottom: 10px;
        }

        .explanation {
            font-size: 0.95rem;
            color: #95a5a6;
            max-width: 600px;
            margin: 0 auto;
        }

        .prediction-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 40px;
            margin-bottom: 40px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .prediction-form {
            max-width: 500px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        select {
            width: 100%;
            padding: 12px;
            font-size: 1.1rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        select:hover {
            border-color: #3498db;
        }

        select:focus {
            outline: none;
            border-color: #3498db;
        }

        .human-check {
            display: flex;
            align-items: center;
            padding: 15px;
            background: #fff;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .human-check:hover {
            border-color: #3498db;
            background: #f8f9fa;
        }

        .human-check input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            cursor: pointer;
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            background: #3498db;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .submit-btn:hover:not(:disabled) {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .submit-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .submit-btn.success {
            background: #27ae60;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: white;
            border: 2px solid #f0f0f0;
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s;
        }

        .stat-card:hover {
            border-color: #3498db;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-label {
            font-size: 0.85rem;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .chart-container {
            background: white;
            border: 2px solid #f0f0f0;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 40px;
        }

        .chart-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }

        #histogram {
            width: 100%;
            height: 300px;
        }

        .timeline-container {
            background: white;
            border: 2px solid #f0f0f0;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 40px;
        }

        #timeline-content {
            width: 100%;
            min-height: 200px;
        }

        #timeline-table table {
            font-size: 0.95rem;
        }

        #timeline-table th {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 1px;
        }

        .share-section {
            text-align: center;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 40px;
        }

        .share-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .share-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            color: white;
            display: inline-block;
        }

        .share-x {
            background: #000000;
        }

        .share-facebook {
            background: #1877F2;
        }

        .share-linkedin {
            background: #0077B5;
        }

        .share-reddit {
            background: #FF4500;
        }

        .share-whatsapp {
            background: #25D366;
        }

        .share-telegram {
            background: #0088cc;
        }

        .share-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .info-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 40px;
            margin-top: 40px;
        }

        .info-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .quote {
            font-style: italic;
            padding: 20px;
            border-left: 4px solid #3498db;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
        }

        .message {
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }

        .message.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            display: block;
        }

        .message.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            display: block;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
            .share-buttons {
                flex-direction: column;
                align-items: center;
            }
            .share-btn {
                width: 200px;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="main-wrapper">
        <!-- Left Ad Space -->
        <aside class="ad-space">
            <div class="ad-placeholder">
                Future Ad Space<br>
                200x600
            </div>
        </aside>

        <!-- Main Content -->
        <main class="container">
            <div style="text-align: center; color: #999; font-size: 0.75rem; margin-top: 10px; margin-bottom: -20px;">
                Est. 2025.08.22
            </div>
            <header>
                <h1>How Long Until AGI?</h1>
                <p class="subtitle">🧠 A Collective Intelligence Experiment</p>
                <p class="explanation">
                    Using the wisdom of crowds to predict when Artificial General Intelligence will arrive.
                    Based on Francis Galton's 1906 ox weight experiment and the Law of Large Numbers.
                </p>
            </header>

            <div class="prediction-card">
                <form class="prediction-form" id="predictionForm">
                    <div class="form-group">
                        <label for="yearSelect">When do you think AGI will arrive?</label>
                        <select id="yearSelect" required>
                            <option value="">Select a year...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="human-check">
                            <input type="checkbox" id="humanCheck" required>
                            <span>I am human (not a bot)</span>
                        </label>
                    </div>

                    <button type="submit" class="submit-btn" id="submitBtn">
                        Submit My Prediction
                    </button>

                    <div class="message" id="message"></div>
                </form>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Predictions</div>
                    <div class="stat-value" id="totalPredictions">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Average (Mean)</div>
                    <div class="stat-value" id="meanYear">—</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Median</div>
                    <div class="stat-value" id="medianYear">—</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Mode</div>
                    <div class="stat-value" id="modeYear">—</div>
                </div>
            </div>

            <div class="chart-container">
                <h3 class="chart-title">Distribution of Predictions</h3>
                <svg id="histogram"></svg>
            </div>

            <div class="timeline-container">
                <h3 class="chart-title">Prediction Trends Over Time</h3>
                <div id="timeline-content">
                    <div id="timeline-chart"></div>
                    <div id="timeline-table" style="margin-top: 20px;"></div>
                </div>
            </div>

            <div class="share-section">
                <h3 style="margin-bottom: 10px;">Share This Experiment</h3>
                <p style="color: #7f8c8d;">Help us gather more predictions by sharing with your network</p>
                <div class="share-buttons">
                    <a href="#" class="share-btn share-x" onclick="shareX(); return false;">
                        Share on X
                    </a>
                    <a href="#" class="share-btn share-facebook" onclick="shareFacebook(); return false;">
                        Share on Facebook
                    </a>
                    <a href="#" class="share-btn share-linkedin" onclick="shareLinkedIn(); return false;">
                        Share on LinkedIn
                    </a>
                    <a href="#" class="share-btn share-reddit" onclick="shareReddit(); return false;">
                        Share on Reddit
                    </a>
                    <a href="#" class="share-btn share-whatsapp" onclick="shareWhatsApp(); return false;">
                        Share on WhatsApp
                    </a>
                    <a href="#" class="share-btn share-telegram" onclick="shareTelegram(); return false;">
                        Share on Telegram
                    </a>
                </div>
            </div>

            <div class="info-section">
                <h3 class="info-title">📊 The Science Behind This Experiment</h3>
                <p>
                    In 1906, Francis Galton observed 787 people at a country fair guessing the weight of an ox. 
                    While individual guesses varied wildly, the median guess was 1,207 pounds—just 9 pounds off 
                    from the actual weight of 1,198 pounds.
                </p>
                
                <div class="quote">
                    "The result seems more creditable to the trustworthiness of a democratic judgment 
                    than might have been expected." — Francis Galton
                </div>
                
                <p>
                    This phenomenon demonstrates that aggregating diverse, independent judgments can produce 
                    remarkably accurate predictions. Can we apply this to predicting AGI? Join thousands of 
                    others in this global experiment.
                </p>
            </div>
        </main>

        <!-- Right Ad Space -->
        <aside class="ad-space">
            <div class="ad-placeholder">
                Future Ad Space<br>
                200x600
            </div>
        </aside>
    </div>

    <script>
        // State management
        let predictions = [];
        let hasVoted = false;
        let predictionsByDate = [];

        // Check if user has already voted (using localStorage for demo)
        function checkVoteStatus() {
            const voted = localStorage.getItem('agi_prediction_voted');
            if (voted) {
                hasVoted = true;
                disableForm();
                showMessage('You have already submitted a prediction.', 'error');
            }
        }

        // Populate year dropdown
        function populateYearDropdown() {
            const select = document.getElementById('yearSelect');
            const currentYear = new Date().getFullYear();
            const lastYear = currentYear - 1;
            
            // Start from last year + 1 (which equals current year) to 2100
            for (let year = lastYear + 1; year <= 2100; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                select.appendChild(option);
            }
        }

        // Form submission
        document.getElementById('predictionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (hasVoted) {
                showMessage('You have already submitted a prediction.', 'error');
                return;
            }
            
            const year = parseInt(document.getElementById('yearSelect').value);
            const humanChecked = document.getElementById('humanCheck').checked;
            
            if (!year || !humanChecked) {
                showMessage('Please select a year and confirm you are human.', 'error');
                return;
            }
            
            // Add loading state
            const btn = document.getElementById('submitBtn');
            btn.innerHTML = 'Submitting... <span class="loading"></span>';
            btn.disabled = true;
            
            // Submit prediction
            submitPrediction(year);
        });

        async function submitPrediction(year) {
            try {
                const response = await fetch('/api/submit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        year: year,
                        humanCheck: true
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Update local state with server data
                    predictions = [];
                    if (data.stats.distribution) {
                        Object.keys(data.stats.distribution).forEach(y => {
                            const count = data.stats.distribution[y];
                            for (let i = 0; i < count; i++) {
                                predictions.push(parseInt(y));
                            }
                        });
                    }
                    
                    // Update stats display
                    document.getElementById('totalPredictions').textContent = data.stats.total;
                    document.getElementById('meanYear').textContent = data.stats.mean;
                    document.getElementById('medianYear').textContent = data.stats.median;
                    document.getElementById('modeYear').textContent = data.stats.mode;
                    
                    // Update visualizations
                    updateHistogram();
                    updateTimeline();
                    
                    // Mark as voted
                    hasVoted = true;
                    localStorage.setItem('agi_prediction_voted', 'true');
                    localStorage.setItem('agi_prediction_year', year);
                    
                    // Update UI
                    disableForm();
                    showMessage(`Thank you! Your prediction of ${year} has been recorded.`, 'success');
                    
                    const btn = document.getElementById('submitBtn');
                    btn.classList.add('success');
                    btn.innerHTML = '✓ Prediction Submitted';
                } else {
                    showMessage(data.error || 'Failed to submit prediction.', 'error');
                    const btn = document.getElementById('submitBtn');
                    btn.innerHTML = 'Submit My Prediction';
                    btn.disabled = false;
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('Network error. Please try again.', 'error');
                const btn = document.getElementById('submitBtn');
                btn.innerHTML = 'Submit My Prediction';
                btn.disabled = false;
            }
        }

        function disableForm() {
            document.getElementById('yearSelect').disabled = true;
            document.getElementById('humanCheck').disabled = true;
            document.getElementById('submitBtn').disabled = true;
        }

        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message ${type}`;
        }

        function calculateMean() {
            if (predictions.length === 0) return null;
            return predictions.reduce((a, b) => a + b, 0) / predictions.length;
        }

        function updateStatistics() {
            const total = predictions.length;
            
            if (total === 0) {
                document.getElementById('totalPredictions').textContent = '0';
                document.getElementById('meanYear').textContent = '—';
                document.getElementById('medianYear').textContent = '—';
                document.getElementById('modeYear').textContent = '—';
                return;
            }
            
            // Calculate statistics
            const mean = calculateMean();
            const sorted = [...predictions].sort((a, b) => a - b);
            const median = sorted[Math.floor(total / 2)];
            
            // Calculate mode
            const frequency = {};
            predictions.forEach(year => {
                frequency[year] = (frequency[year] || 0) + 1;
            });
            const mode = Object.keys(frequency).reduce((a, b) => 
                frequency[a] > frequency[b] ? a : b
            );
            
            // Update display
            document.getElementById('totalPredictions').textContent = total.toLocaleString();
            document.getElementById('meanYear').textContent = mean.toFixed(1);
            document.getElementById('medianYear').textContent = median;
            document.getElementById('modeYear').textContent = mode;
        }

        function updateHistogram() {
            const svg = document.getElementById('histogram');
            
            if (predictions.length === 0) {
                svg.innerHTML = '<text x="50%" y="50%" text-anchor="middle" fill="#999">No predictions yet</text>';
                return;
            }
            
            const width = svg.clientWidth;
            const height = 300;
            const margin = { top: 20, right: 30, bottom: 40, left: 40 };
            const innerWidth = width - margin.left - margin.right;
            const innerHeight = height - margin.top - margin.bottom;
            
            // Create bins
            const bins = {};
            predictions.forEach(year => {
                bins[year] = (bins[year] || 0) + 1;
            });
            
            const years = Object.keys(bins).map(Number).sort((a, b) => a - b);
            const counts = years.map(year => bins[year]);
            const maxCount = Math.max(...counts);
            
            // Clear and redraw
            svg.innerHTML = '';
            
            // Create bars
            const barWidth = Math.min(40, innerWidth / years.length - 5);
            const xScale = years.length > 1 ? (innerWidth - barWidth) / (years.length - 1) : 0;
            
            years.forEach((year, i) => {
                const count = bins[year];
                const barHeight = (count / maxCount) * innerHeight;
                const x = margin.left + (years.length > 1 ? i * xScale : innerWidth / 2 - barWidth / 2);
                const y = margin.top + innerHeight - barHeight;
                
                // Bar
                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('x', x);
                rect.setAttribute('y', y);
                rect.setAttribute('width', barWidth);
                rect.setAttribute('height', barHeight);
                rect.setAttribute('fill', '#3498db');
                rect.setAttribute('rx', '4');
                svg.appendChild(rect);
                
                // Year label
                const yearLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                yearLabel.setAttribute('x', x + barWidth / 2);
                yearLabel.setAttribute('y', height - 10);
                yearLabel.setAttribute('text-anchor', 'middle');
                yearLabel.setAttribute('fill', '#666');
                yearLabel.setAttribute('font-size', '12');
                yearLabel.textContent = year;
                svg.appendChild(yearLabel);
                
                // Count label
                const countLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                countLabel.setAttribute('x', x + barWidth / 2);
                countLabel.setAttribute('y', y - 5);
                countLabel.setAttribute('text-anchor', 'middle');
                countLabel.setAttribute('fill', '#333');
                countLabel.setAttribute('font-size', '14');
                countLabel.setAttribute('font-weight', 'bold');
                countLabel.textContent = count;
                svg.appendChild(countLabel);
            });
        }

        function updateTimeline() {
            const timelineContent = document.getElementById('timeline-content');
            
            // Load timeline data from API
            fetch('/api/timeline')
                .then(response => response.json())
                .then(data => {
                    if (!data.timeline || data.timeline.length === 0) {
                        timelineContent.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Timeline will appear after predictions are made</p>';
                        return;
                    }
                    
                    // Summary cards
                    let summaryHTML = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 8px;">
                                <div style="font-size: 0.9rem; opacity: 0.9;">Total Voters</div>
                                <div style="font-size: 1.8rem; font-weight: bold;">${data.totalVoters || data.timeline.reduce((sum, y) => sum + y.count, 0)}</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 15px; border-radius: 8px;">
                                <div style="font-size: 0.9rem; opacity: 0.9;">Years Tracked</div>
                                <div style="font-size: 1.8rem; font-weight: bold;">${data.timeline.length}</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 15px; border-radius: 8px;">
                                <div style="font-size: 0.9rem; opacity: 0.9;">Overall Average</div>
                                <div style="font-size: 1.8rem; font-weight: bold;">${data.summary?.overallAverage || calculateMean()?.toFixed(1) || '—'}</div>
                            </div>
                        </div>
                    `;
                    
                    // Create timeline table
                    let tableHTML = `
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom: 2px solid #e0e0e0;">
                                    <th style="padding: 10px; text-align: left; color: #666;">Vote Year</th>
                                    <th style="padding: 10px; text-align: center; color: #666;">New Voters</th>
                                    <th style="padding: 10px; text-align: center; color: #666;">Total Voters</th>
                                    <th style="padding: 10px; text-align: center; color: #666;">Avg Prediction</th>
                                    <th style="padding: 10px; text-align: center; color: #666;">Most Common</th>
                                    <th style="padding: 10px; text-align: center; color: #666;">Range</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    // Calculate trends
                    data.timeline.forEach((yearData, index) => {
                        const prevAvg = index > 0 ? parseFloat(data.timeline[index - 1].averagePrediction) : null;
                        const currentAvg = parseFloat(yearData.averagePrediction);
                        let trend = '';
                        if (prevAvg !== null) {
                            if (currentAvg < prevAvg) trend = '📉 ↓' + Math.abs(currentAvg - prevAvg).toFixed(1);
                            else if (currentAvg > prevAvg) trend = '📈 ↑' + Math.abs(currentAvg - prevAvg).toFixed(1);
                            else trend = '➡️';
                        }
                        
                        const isCurrentYear = yearData.year === new Date().getFullYear();
                        const rowStyle = isCurrentYear ? 'background: #e3f2fd;' : '';
                        
                        tableHTML += `
                            <tr style="border-bottom: 1px solid #f0f0f0; ${rowStyle}">
                                <td style="padding: 10px; font-weight: 600;">
                                    ${yearData.year} ${isCurrentYear ? '📍' : ''}
                                </td>
                                <td style="padding: 10px; text-align: center;">
                                    <span style="background: #3498db; color: white; padding: 2px 8px; border-radius: 4px;">
                                        +${yearData.count}
                                    </span>
                                </td>
                                <td style="padding: 10px; text-align: center; font-weight: 600;">
                                    ${yearData.cumulativeCount || yearData.count}
                                </td>
                                <td style="padding: 10px; text-align: center;">
                                    <span style="font-size: 1.2rem; font-weight: bold; color: #2c3e50;">
                                        ${yearData.averagePrediction}
                                    </span>
                                    ${trend ? `<br><small style="color: #666;">${trend}</small>` : ''}
                                </td>
                                <td style="padding: 10px; text-align: center; color: #7f8c8d;">
                                    ${yearData.mostCommon || yearData.averagePrediction.split('.')[0]}
                                </td>
                                <td style="padding: 10px; text-align: center; color: #95a5a6; font-size: 0.9rem;">
                                    ${yearData.minPrediction}-${yearData.maxPrediction}
                                </td>
                            </tr>
                        `;
                    });
                    
                    tableHTML += `
                            </tbody>
                        </table>
                    `;
                    
                    // Trend analysis
                    if (data.timeline.length > 1) {
                        const firstYear = data.timeline[0];
                        const lastYear = data.timeline[data.timeline.length - 1];
                        const change = parseFloat(lastYear.averagePrediction) - parseFloat(firstYear.averagePrediction);
                        const trend = change < 0 ? 'more optimistic (sooner)' : change > 0 ? 'more conservative (later)' : 'stable';
                        const color = change < 0 ? '#27ae60' : change > 0 ? '#e74c3c' : '#95a5a6';
                        
                        tableHTML += `
                            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                <h4 style="margin-bottom: 10px;">📊 Trend Analysis</h4>
                                <p>From ${firstYear.year} to ${lastYear.year}, predictions became 
                                <strong style="color: ${color};">${trend}</strong></p>
                                ${change !== 0 ? `<p>Average shifted by <strong>${Math.abs(change).toFixed(1)} years</strong></p>` : ''}
                                <p style="margin-top: 10px; color: #666;">
                                    Growth rate: <strong>${((lastYear.cumulativeCount / firstYear.count - 1) * 100).toFixed(0)}%</strong> more voters
                                </p>
                            </div>
                        `;
                    }
                    
                    // Current year highlight
                    const currentYear = new Date().getFullYear();
                    const currentYearData = data.timeline.find(y => y.year === currentYear);
                    if (currentYearData) {
                        tableHTML += `
                            <div style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; color: white; text-align: center;">
                                <h3 style="margin-bottom: 10px;">📅 ${currentYear} Consensus</h3>
                                <div style="font-size: 2.5rem; font-weight: bold;">
                                    AGI in ${currentYearData.averagePrediction}
                                </div>
                                <div style="margin-top: 10px; opacity: 0.9;">
                                    ${currentYearData.count} voter${currentYearData.count > 1 ? 's' : ''} this year
                                    • Most think ${currentYearData.mostCommon || currentYearData.averagePrediction.split('.')[0]}
                                </div>
                            </div>
                        `;
                    }
                    
                    document.getElementById('timeline-content').innerHTML = summaryHTML + tableHTML;
                })
                .catch(error => {
                    console.error('Error loading timeline:', error);
                    // Fallback to original display if timeline API not available
                    updateTimelineFallback();
                });
        }
        
        // Fallback function for when timeline API is not available
        function updateTimelineFallback() {
            const timelineContent = document.getElementById('timeline-content');
            
            if (predictions.length === 0) {
                timelineContent.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Timeline will appear after first prediction</p>';
                return;
            }
            
            // Original simple display
            const runningAvg = calculateMean();
            timelineContent.innerHTML = `
                <div style="padding: 20px; background: #f8f9fa; border-radius: 8px; text-align: center;">
                    <strong>Current Average Prediction:</strong> 
                    <span style="font-size: 1.5rem; color: #3498db;">${runningAvg ? runningAvg.toFixed(1) : '—'}</span>
                </div>
            `;
        }

        // Load initial stats from server
        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                
                // Check if response is OK and is JSON
                if (!response.ok) {
                    console.log('Stats API not available yet');
                    return;
                }
                
                const contentType = response.headers.get("content-type");
                if (!contentType || !contentType.includes("application/json")) {
                    console.log('Stats API not returning JSON yet');
                    return;
                }
                
                const data = await response.json();
                
                if (data.stats && data.stats.total > 0) {
                    // Update statistics display
                    document.getElementById('totalPredictions').textContent = data.stats.total;
                    document.getElementById('meanYear').textContent = data.stats.mean || '—';
                    document.getElementById('medianYear').textContent = data.stats.median || '—';
                    document.getElementById('modeYear').textContent = data.stats.mode || '—';
                    
                    // Rebuild predictions array from distribution
                    predictions = [];
                    if (data.stats.distribution) {
                        Object.keys(data.stats.distribution).forEach(y => {
                            const count = data.stats.distribution[y];
                            for (let i = 0; i < count; i++) {
                                predictions.push(parseInt(y));
                            }
                        });
                    }
                    
                    // Update visualizations
                    updateHistogram();
                    updateTimeline();
                }
            } catch (error) {
                // Silently fail - API not ready yet
                console.log('Stats loading skipped - API not ready');
            }
        }

        // Social sharing functions
        function shareX() {
            const text = `I just predicted when AGI will arrive! Join the collective intelligence experiment at howlonguntilagi.com`;
            const url = `https://x.com/intent/tweet?text=${encodeURIComponent(text)}`;
            window.open(url, '_blank');
        }

        function shareFacebook() {
            const url = 'https://howlonguntilagi.com';
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`, '_blank');
        }

        function shareLinkedIn() {
            const url = 'https://howlonguntilagi.com';
            window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url)}`, '_blank');
        }

        function shareReddit() {
            const url = 'https://howlonguntilagi.com';
            const title = 'Predicting AGI arrival using the wisdom of crowds';
            window.open(`https://reddit.com/submit?url=${encodeURIComponent(url)}&title=${encodeURIComponent(title)}`, '_blank');
        }

        function shareWhatsApp() {
            const text = 'Check out this collective intelligence experiment predicting when AGI will arrive: https://howlonguntilagi.com';
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        }

        function shareTelegram() {
            const url = 'https://howlonguntilagi.com';
            const text = 'Predicting AGI arrival using collective intelligence';
            window.open(`https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}`, '_blank');
        }

        // Initialize
        populateYearDropdown();
        checkVoteStatus();
        loadStats();
    </script>
</body>
</html>
